#!/bin/bash

# ===================================================================
# Installer Bot Telegram PPOB v6 (Paling Stabil)
# Fitur: Pembersihan Total, Impor DB, & Perbaikan Skema Tabel Otomatis
# ===================================================================

# Warna
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- KONFIGURASI HARDCODED (API & DATABASE) ---
KMSP_API_KEY="e6ee99e0-c853-45fb-b1fc-d8cd8a6da062"
DB_NAME="cekotmyi_ppob"
DB_USER="cekotmyi_ppob"
DB_PASSWORD="1ndosaTaku"
DB_ROOT_PASSWORD=$(openssl rand -base64 12)
# ---------------------------------------------------

# Variabel Proyek
REPO_URL="https://github.com/hokagelegend9999/Dor-Paket.git"
INSTALL_DIR="/opt/bot_ppob"
SERVICE_NAME="bot-ppob.service"

# Fungsi pengecekan root
check_root() { if [[ "${EUID}" -ne 0 ]]; then echo -e "${RED}Error: Jalankan sebagai root.${NC}"; exit 1; fi }

# Fungsi Membersihkan instalasi lama
cleanup_previous_installation() {
    echo -e "\n${YELLOW}--> Membersihkan instalasi sebelumnya secara total...${NC}"
    systemctl stop $SERVICE_NAME >/dev/null 2>&1
    systemctl disable $SERVICE_NAME >/dev/null 2>&1
    rm -f /etc/systemd/system/$SERVICE_NAME
    systemctl daemon-reload
    rm -rf $INSTALL_DIR
    echo "--> Menghapus total MariaDB..."
    apt-get purge -y mariadb-server mariadb-client mariadb-common >/dev/null 2>&1
    rm -rf /var/lib/mysql /etc/mysql
    apt-get autoremove -y >/dev/null 2>&1
    echo -e "${GREEN}--> Pembersihan selesai.${NC}"
}

# Fungsi untuk mendapatkan input Telegram
get_telegram_input() {
    echo -e "${YELLOW}===== Konfigurasi Wajib Bot Telegram =====${NC}"
    read -p "Masukkan BOT_TOKEN Anda: " BOT_TOKEN
    read -p "Masukkan ADMIN_TELEGRAM_ID Anda: " ADMIN_TELEGRAM_ID
}

# Fungsi instalasi dependensi
install_dependencies() {
    echo -e "\n${GREEN}--> Menginstal dependensi...${NC}"
    apt-get update > /dev/null 2>&1
    apt-get install -y python3-pip python3-venv mariadb-server git curl > /dev/null 2>&1
}

# Fungsi setup database
setup_database() {
    echo -e "\n${GREEN}--> Mengkonfigurasi MariaDB...${NC}"
    systemctl start mariadb
    systemctl enable mariadb
    sudo mariadb -e "CREATE DATABASE IF NOT EXISTS $DB_NAME;"
    sudo mariadb -e "CREATE USER IF NOT EXISTS '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
    sudo mariadb -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
    sudo mariadb -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '$DB_ROOT_PASSWORD';"
    sudo mariadb -e "FLUSH PRIVILEGES;"
    echo -e "${GREEN}--> Database dan user berhasil dikonfigurasi.${NC}"
}

# Fungsi untuk clone repo dan konfigurasi
clone_and_configure() {
    echo -e "\n${GREEN}--> Mengkloning repositori dari GitHub...${NC}"
    git clone $REPO_URL $INSTALL_DIR
    echo -e "\n${GREEN}--> Membuat file config.py...${NC}"
    cat << EOF > "$INSTALL_DIR/config.py"
BOT_TOKEN = "$BOT_TOKEN"
ADMIN_TELEGRAM_ID = $ADMIN_TELEGRAM_ID
KMSP_API_KEY = '$KMSP_API_KEY'
DB_HOST = 'localhost'
DB_USER = '$DB_USER'
DB_PASSWORD = '$DB_PASSWORD'
DB_NAME = '$DB_NAME'
EOF
    echo -e "\n${GREEN}--> Menginstal library Python...${NC}"
    python3 -m venv "$INSTALL_DIR/venv"
    "$INSTALL_DIR/venv/bin/pip" install -r "$INSTALL_DIR/requirements.txt" > /dev/null 2>&1
}

# --- FUNGSI IMPOR DATABASE YANG DISEMPURNAKAN ---
import_database_data() {
    DB_SQL_FILE="$INSTALL_DIR/cekotmyi_ppob.sql"
    if [ -f "$DB_SQL_FILE" ]; then
        echo -e "\n${GREEN}--> Mengimpor data dari 'cekotmyi_ppob.sql'...${NC}"
        mariadb -u root -p"$DB_ROOT_PASSWORD" "$DB_NAME" < "$DB_SQL_FILE"
        echo -e "${GREEN}--> Data database berhasil diimpor.${NC}"

        # --- PERBAIKAN: Tambahkan kolom yang hilang setelah impor ---
        echo -e "\n${YELLOW}--> Memperbarui struktur tabel 'users' untuk menambahkan kolom 'telegram_user_id'...${NC}"
        mariadb -u root -p"$DB_ROOT_PASSWORD" "$DB_NAME" -e "ALTER TABLE users ADD COLUMN IF NOT EXISTS telegram_user_id BIGINT UNIQUE AFTER id;"
        echo -e "${GREEN}--> Struktur tabel 'users' berhasil diperbarui.${NC}"
        # --------------------------------------------------------
    else
        echo -e "\n${YELLOW}--> PERINGATAN: File 'cekotmyi_ppob.sql' tidak ditemukan.${NC}"
    fi
}

# Fungsi membuat layanan systemd
create_systemd_service() {
    echo -e "\n${GREEN}--> Membuat layanan systemd...${NC}"
    cat << EOF > /etc/systemd/system/$SERVICE_NAME
[Unit]
Description=Bot PPOB Service
After=network.target mariadb.service
[Service]
User=root
Group=root
WorkingDirectory=$INSTALL_DIR
ExecStart=$INSTALL_DIR/venv/bin/python3 main.py
Restart=always
RestartSec=5
[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable $SERVICE_NAME
    systemctl start $SERVICE_NAME
}

# --- Fungsi Utama ---
main() {
    check_root
    cleanup_previous_installation
    get_telegram_input
    echo -e "${YELLOW}Memulai instalasi Bot PPOB...${NC}"
    install_dependencies
    setup_database
    clone_and_configure
    import_database_data
    create_systemd_service
    
    echo -e "\n\n${GREEN}=====================================================${NC}"
    echo -e "${GREEN}      âœ… Instalasi Bot PPOB Selesai!${NC}"
    echo -e "${GREEN}=====================================================${NC}"
    echo -e "Layanan bot berjalan: ${YELLOW}$SERVICE_NAME${NC}"
    echo -e "Cek status: ${YELLOW}systemctl status $SERVICE_NAME${NC}"
    echo -e "Lihat log: ${YELLOW}journalctl -u $SERVICE_NAME -f${NC}"
    echo -e "\n${YELLOW}Password root MariaDB (SIMPAN!): ${NC}${DB_ROOT_PASSWORD}"
    echo ""
}

main
