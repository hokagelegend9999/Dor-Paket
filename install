#!/bin/bash

# ===================================================================
# Installer Bot Telegram PPOB (Interaktif untuk Token & ID)
# ===================================================================

# Warna
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- KONFIGURASI HARDCODED (API & DATABASE) ---
KMSP_API_KEY="e6ee99e0-c853-45fb-b1fc-d8cd8a6da062"
DB_NAME="cekotmyi_ppob"
DB_USER="cekotmyi_ppob"
DB_PASSWORD="1ndosaTaku"
DB_ROOT_PASSWORD=$(openssl rand -base64 12) # Password root MariaDB dibuat acak
# ---------------------------------------------------

# Variabel Proyek
REPO_URL="https://github.com/hokagelegend9999/Dor-Paket.git"
INSTALL_DIR="/opt/bot_ppob"
SERVICE_NAME="bot-ppob.service"

# Fungsi pengecekan root
check_root() {
    if [[ "${EUID}" -ne 0 ]]; then
        echo -e "${RED}Error: Skrip ini harus dijalankan sebagai root.${NC}"
        exit 1
    fi
}

# --- FUNGSI INTERAKTIF BARU ---
# Fungsi untuk mendapatkan input Telegram dari pengguna
get_telegram_input() {
    echo -e "${YELLOW}===== Konfigurasi Wajib Bot Telegram =====${NC}"
    read -p "Masukkan BOT_TOKEN Anda: " BOT_TOKEN
    while [ -z "$BOT_TOKEN" ]; do
        echo -e "${RED}BOT_TOKEN tidak boleh kosong.${NC}"
        read -p "Masukkan BOT_TOKEN Anda: " BOT_TOKEN
    done
    
    read -p "Masukkan ADMIN_TELEGRAM_ID Anda: " ADMIN_TELEGRAM_ID
    while [ -z "$ADMIN_TELEGRAM_ID" ]; do
        echo -e "${RED}ADMIN_TELEGRAM_ID tidak boleh kosong.${NC}"
        read -p "Masukkan ADMIN_TELEGRAM_ID Anda: " ADMIN_TELEGRAM_ID
    done
}
# --------------------------------

# Fungsi instalasi dependensi
install_dependencies() {
    echo -e "\n${GREEN}--> Mengupdate sistem dan menginstal dependensi...${NC}"
    apt-get update > /dev/null 2>&1
    apt-get install -y python3-pip python3-venv mariadb-server git curl > /dev/null 2>&1
    echo -e "${GREEN}--> Dependensi sistem berhasil diinstal.${NC}"
}

# Fungsi setup database
setup_database() {
    echo -e "\n${GREEN}--> Menjalankan dan mengamankan MariaDB...${NC}"
    systemctl start mariadb
    systemctl enable mariadb
    
    mariadb -e "UPDATE mysql.user SET Password = PASSWORD('$DB_ROOT_PASSWORD') WHERE User = 'root';"
    mariadb -e "DELETE FROM mysql.user WHERE User='';"
    mariadb -e "FLUSH PRIVILEGES;"
    
    echo -e "\n${GREEN}--> Membuat database dan user untuk bot...${NC}"
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "CREATE DATABASE $DB_NAME;"
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "FLUSH PRIVILEGES;"
    echo -e "${GREEN}--> Database '$DB_NAME' dan user '$DB_USER' berhasil dibuat.${NC}"
}

# Fungsi untuk clone repo dan konfigurasi
clone_and_configure() {
    echo -e "\n${GREEN}--> Mengkloning repositori dari GitHub ke $INSTALL_DIR...${NC}"
    rm -rf $INSTALL_DIR
    git clone $REPO_URL $INSTALL_DIR
    
    echo -e "\n${GREEN}--> Membuat file config.py dengan data Anda...${NC}"
    cat << EOF > "$INSTALL_DIR/config.py"
# File ini dibuat otomatis oleh installer.

# Konfigurasi dari input interaktif
BOT_TOKEN = "$BOT_TOKEN"
ADMIN_TELEGRAM_ID = $ADMIN_TELEGRAM_ID

# Konfigurasi dari data hardcoded
KMSP_API_KEY = '$KMSP_API_KEY'
DB_HOST = 'localhost'
DB_USER = '$DB_USER'
DB_PASSWORD = '$DB_PASSWORD'
DB_NAME = '$DB_NAME'
EOF

    echo -e "\n${GREEN}--> Membuat virtual environment dan menginstal library Python...${NC}"
    python3 -m venv "$INSTALL_DIR/venv"
    "$INSTALL_DIR/venv/bin/pip" install -r "$INSTALL_DIR/requirements.txt" > /dev/null 2>&1
    echo -e "${GREEN}--> Library Python berhasil diinstal.${NC}"
}

# Fungsi membuat layanan systemd
create_systemd_service() {
    echo -e "\n${GREEN}--> Membuat layanan systemd ($SERVICE_NAME)...${NC}"
    cat << EOF > /etc/systemd/system/$SERVICE_NAME
[Unit]
Description=Bot PPOB Telegram Service
After=network.target mariadb.service

[Service]
User=root
Group=root
WorkingDirectory=$INSTALL_DIR
ExecStart=$INSTALL_DIR/venv/bin/python3 main.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    echo -e "\n${GREEN}--> Menjalankan dan mengaktifkan layanan bot...${NC}"
    systemctl daemon-reload
    systemctl enable $SERVICE_NAME
    systemctl start $SERVICE_NAME
}

# --- Fungsi Utama ---
main() {
    check_root
    # Panggil fungsi untuk meminta input Telegram
    get_telegram_input
    
    echo -e "${YELLOW}Memulai instalasi otomatis Bot PPOB...${NC}"
    install_dependencies
    setup_database
    clone_and_configure
    create_systemd_service
    
    echo -e "\n\n${GREEN}=================================================================${NC}"
    echo -e "${GREEN}      âœ… Instalasi Bot PPOB Selesai!${NC}"
    echo -e "${GREEN}=================================================================${NC}"
    echo -e "\nLayanan bot sekarang berjalan dengan nama ${YELLOW}$SERVICE_NAME${NC}"
    echo -e "Untuk mengecek status: ${YELLOW}systemctl status $SERVICE_NAME${NC}"
    echo -e "Untuk melihat log: ${YELLOW}journalctl -u $SERVICE_NAME -f${NC}"
    echo -e "\n${YELLOW}Password root untuk MariaDB Anda (SIMPAN DI TEMPAT AMAN):${NC}"
    echo -e "--> ${DB_ROOT_PASSWORD}"
    echo -e "\n${RED}LANGKAH TERAKHIR YANG PENTING:${NC}"
    echo -e "Anda harus mengimpor data dari file backup .sql ke database '$DB_NAME'."
    echo -e "Gunakan perintah ini setelah mengunggah file .sql ke VPS:"
    echo -e "${YELLOW}mysql -u $DB_USER -p'$DB_PASSWORD' $DB_NAME < /path/to/your/backup.sql${NC}"
    echo ""
}

main
