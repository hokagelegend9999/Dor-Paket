#!/bin/bash

# ===================================================================
# Installer Bot Telegram PPOB v3 (Final - Perbaikan DB)
# Fitur: Pembersihan, Impor DB Otomatis, Perintah DB Modern
# ===================================================================

# Warna
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- KONFIGURASI HARDCODED (API & DATABASE) ---
KMSP_API_KEY="e6ee99e0-c853-45fb-b1fc-d8cd8a6da062"
DB_NAME="cekotmyi_ppob"
DB_USER="cekotmyi_ppob"
DB_PASSWORD="1ndosaTaku"
DB_ROOT_PASSWORD=$(openssl rand -base64 12)
# ---------------------------------------------------

# Variabel Proyek
REPO_URL="https://github.com/hokagelegend9999/Dor-Paket.git"
INSTALL_DIR="/opt/bot_ppob"
SERVICE_NAME="bot-ppob.service"

# Fungsi pengecekan root
check_root() {
    if [[ "${EUID}" -ne 0 ]]; then
        echo -e "${RED}Error: Skrip ini harus dijalankan sebagai root.${NC}"
        exit 1
    fi
}

# Fungsi Membersihkan instalasi lama
cleanup_previous_installation() {
    echo -e "\n${YELLOW}--> Memeriksa dan membersihkan instalasi sebelumnya...${NC}"
    if systemctl is-active --quiet $SERVICE_NAME; then
        systemctl stop $SERVICE_NAME
    fi
    if systemctl is-enabled --quiet $SERVICE_NAME; then
        systemctl disable $SERVICE_NAME
    fi
    rm -f /etc/systemd/system/$SERVICE_NAME
    systemctl daemon-reload
    if [ -d "$INSTALL_DIR" ]; then
        rm -rf $INSTALL_DIR
    fi
    echo -e "${GREEN}--> Pembersihan selesai.${NC}"
}

# Fungsi untuk mendapatkan input Telegram
get_telegram_input() {
    echo -e "${YELLOW}===== Konfigurasi Wajib Bot Telegram =====${NC}"
    read -p "Masukkan BOT_TOKEN Anda: " BOT_TOKEN
    while [ -z "$BOT_TOKEN" ]; do
        echo -e "${RED}BOT_TOKEN tidak boleh kosong.${NC}"
        read -p "Masukkan BOT_TOKEN Anda: " BOT_TOKEN
    done
    read -p "Masukkan ADMIN_TELEGRAM_ID Anda: " ADMIN_TELEGRAM_ID
    while [ -z "$ADMIN_TELEGRAM_ID" ]; do
        echo -e "${RED}ADMIN_TELEGRAM_ID tidak boleh kosong.${NC}"
        read -p "Masukkan ADMIN_TELEGRAM_ID Anda: " ADMIN_TELEGRAM_ID
    done
}

# Fungsi instalasi dependensi
install_dependencies() {
    echo -e "\n${GREEN}--> Mengupdate sistem dan menginstal dependensi...${NC}"
    apt-get update > /dev/null 2>&1
    apt-get install -y python3-pip python3-venv mariadb-server git curl > /dev/null 2>&1
    echo -e "${GREEN}--> Dependensi sistem berhasil diinstal.${NC}"
}

# --- FUNGSI DATABASE YANG DIPERBAIKI ---
setup_database() {
    echo -e "\n${GREEN}--> Menjalankan dan mengkonfigurasi MariaDB...${NC}"
    systemctl start mariadb
    systemctl enable mariadb
    
    # Perintah modern untuk mengatur password root
    mariadb -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '$DB_ROOT_PASSWORD';"
    mariadb -e "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');"
    mariadb -e "DELETE FROM mysql.user WHERE User='';"
    mariadb -e "DROP DATABASE IF EXISTS test;"
    mariadb -e "FLUSH PRIVILEGES;"
    
    echo -e "\n${GREEN}--> Membuat database dan user untuk bot (menghapus yang lama jika ada)...${NC}"
    # Hapus database dan user lama untuk memastikan instalasi bersih
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "DROP DATABASE IF EXISTS $DB_NAME;"
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "DROP USER IF EXISTS '$DB_USER'@'localhost';"
    
    # Buat yang baru
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "CREATE DATABASE $DB_NAME;"
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
    mariadb -u root -p"$DB_ROOT_PASSWORD" -e "FLUSH PRIVILEGES;"
    echo -e "${GREEN}--> Database '$DB_NAME' dan user '$DB_USER' berhasil dibuat.${NC}"
}

# Fungsi untuk clone repo dan konfigurasi
clone_and_configure() {
    echo -e "\n${GREEN}--> Mengkloning repositori dari GitHub ke $INSTALL_DIR...${NC}"
    git clone $REPO_URL $INSTALL_DIR
    
    echo -e "\n${GREEN}--> Membuat file config.py...${NC}"
    cat << EOF > "$INSTALL_DIR/config.py"
BOT_TOKEN = "$BOT_TOKEN"
ADMIN_TELEGRAM_ID = $ADMIN_TELEGRAM_ID
KMSP_API_KEY = '$KMSP_API_KEY'
DB_HOST = 'localhost'
DB_USER = '$DB_USER'
DB_PASSWORD = '$DB_PASSWORD'
DB_NAME = '$DB_NAME'
EOF

    echo -e "\n${GREEN}--> Menginstal library Python...${NC}"
    python3 -m venv "$INSTALL_DIR/venv"
    "$INSTALL_DIR/venv/bin/pip" install -r "$INSTALL_DIR/requirements.txt" > /dev/null 2>&1
    echo -e "${GREEN}--> Library Python berhasil diinstal.${NC}"
}

# Fungsi Impor data dari file .sql
import_database_data() {
    DB_SQL_FILE="$INSTALL_DIR/cekotmyi_ppob.sql"
    if [ -f "$DB_SQL_FILE" ]; then
        echo -e "\n${GREEN}--> File 'cekotmyi_ppob.sql' ditemukan, mengimpor data...${NC}"
        mariadb -u root -p"$DB_ROOT_PASSWORD" "$DB_NAME" < "$DB_SQL_FILE"
        echo -e "${GREEN}--> Data database berhasil diimpor.${NC}"
    else
        echo -e "\n${YELLOW}--> PERINGATAN: File 'cekotmyi_ppob.sql' tidak ditemukan di repositori.${NC}"
    fi
}

# Fungsi membuat layanan systemd
create_systemd_service() {
    echo -e "\n${GREEN}--> Membuat layanan systemd ($SERVICE_NAME)...${NC}"
    cat << EOF > /etc/systemd/system/$SERVICE_NAME
[Unit]
Description=Bot PPOB Telegram Service
After=network.target mariadb.service

[Service]
User=root
Group=root
WorkingDirectory=$INSTALL_DIR
ExecStart=$INSTALL_DIR/venv/bin/python3 main.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    echo -e "\n${GREEN}--> Menjalankan dan mengaktifkan layanan bot...${NC}"
    systemctl daemon-reload
    systemctl enable $SERVICE_NAME
    systemctl start $SERVICE_NAME
}

# --- Fungsi Utama ---
main() {
    check_root
    cleanup_previous_installation
    get_telegram_input
    
    echo -e "${YELLOW}Memulai instalasi Bot PPOB...${NC}"
    install_dependencies
    setup_database
    clone_and_configure
    import_database_data
    create_systemd_service
    
    echo -e "\n\n${GREEN}=================================================================${NC}"
    echo -e "${GREEN}      âœ… Instalasi Bot PPOB Selesai!${NC}"
    echo -e "${GREEN}=================================================================${NC}"
    echo -e "\nLayanan bot sekarang berjalan dengan nama ${YELLOW}$SERVICE_NAME${NC}"
    echo -e "Untuk mengecek status: ${YELLOW}systemctl status $SERVICE_NAME${NC}"
    echo -e "Untuk melihat log: ${YELLOW}journalctl -u $SERVICE_NAME -f${NC}"
    echo -e "\n${YELLOW}Password root untuk MariaDB Anda (SIMPAN DI TEMPAT AMAN):${NC}"
    echo -e "--> ${DB_ROOT_PASSWORD}"
    echo ""
}

main
